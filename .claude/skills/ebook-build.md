# /ebook-build — 原稿結合・仕上げ

仕上げ担当メンバーを起動し、全章を1つの原稿ファイルに結合する。
巻末の必須要素（レビュー依頼文・特典オファー・著者プロフィール）の存在も最終確認する。
全工程完了後、チームメンバーをシャットダウンしチームを削除する。
引数: 書籍スラッグ（例: `/ebook-build ai-business-guide`）

## 手順

1. 現在のブランチが `feature/{slug}` であることを確認する。異なる場合はチェックアウトする。
2. `books/{slug}/book.yaml` を読み込む（戦略設計フィールド含む）

### Phase 0: チーム確認

3. チーム `ebook-{slug}` の存在を確認する（`~/.claude/teams/ebook-{slug}/config.json` を Read で確認）
   - 存在する場合: そのまま利用する
   - 存在しない場合: `TeamCreate(team_name="ebook-{slug}")` で作成する

### Phase 1: タスク作成・メンバー起動

4. タスクを作成する：
   - `TaskCreate("原稿結合")` → finalizer に割り当て

5. 仕上げ担当メンバーを起動する

#### 仕上げ担当（Finalizer）メンバー

- `subagent_type: "general-purpose"`
- `team_name: "ebook-{slug}"`
- `name: "finalizer"`
- プロンプト内容：

```
あなたは出版社の仕上げ担当です。チーム「ebook-{slug}」の finalizer として活動します。

## チーム作業ルール
- TaskList で自分に割り当てられたタスク「原稿結合」を確認すること
- 作業開始時に TaskUpdate(status="in_progress") を実行すること
- 作業完了時に TaskUpdate(status="completed") を実行すること
- 問題がある場合は SendMessage(recipient="editor-in-chief") で編集長に確認できる

## タスク: 原稿の結合・仕上げ

【書籍情報】
{book.yamlの内容（戦略設計フィールド含む）}

【指示】
1. books/{slug}/chapters/ 内の全Markdownファイルをファイル名順に読み込む
2. 各章からフロントマター（---で囲まれた部分）を除去する
3. 以下の順序で結合する：
   - タイトルページ
   - 目次（章タイトルから自動生成）
   - はじめに（00-introduction.md）
   - 各章（01〜NN）
   - あとがき（99-afterword.md）
   - 奥付
4. books/{slug}/manuscript.md として保存する

【巻末の必須要素チェック（重要）】
あとがき（99-afterword.md）に以下が含まれていることを確認すること。
不足している場合はあとがきの末尾に追加すること：

1. レビュー依頼文:
   「本書が少しでもお役に立てたなら、Amazonでの評価をいただけると大変励みになります。
   皆さまの声が、次の読者への最高のガイドになります。」

2. 読者限定特典オファー（バックエンド導線）:
   {backend_offer} に基づく特典案内のプレースホルダ
   例: 「【読者限定特典】{特典内容}を無料でプレゼント中です。
   詳しくは下記URLをご覧ください。
   [URL: ここにリンクを挿入]」

3. 著者プロフィール:
   著者の経歴・実績を簡潔にまとめた紹介文。
   権威性と親近感を両立させること。

【出力形式】
# {書籍タイトル}

{サブタイトル}

**著者**: {著者名}

---

## 目次

1. はじめに
2. 第1章: {タイトル}
3. 第2章: {タイトル}
...
N. あとがき

---

（各章の本文。章と章の間は --- で区切る）

---

## 奥付

**{書籍タイトル}**
著者: {著者名}
発行日: {日付}

本書の内容の無断転載を禁じます。
(c) {年} {著者名}

【結合後に報告する統計】
- 総章数
- 総文字数
- 各章の文字数
- 目標文字数（20,000文字前後）との差分
- ステータスが complete でない章があれば警告
- 巻末必須要素の存在確認結果（レビュー依頼文/特典オファー/著者プロフィール）
```

### Phase 2: 完了処理・チームクリーンアップ

6. finalizerのタスク完了を確認する（TaskList で「原稿結合」が completed であること）
7. 統計レポートを整理する
8. 全メンバーをシャットダウンする：
   - `finalizer` に `SendMessage(type="shutdown_request")` を送信
   - `editor-in-chief`（存続していた場合）に `SendMessage(type="shutdown_request")` を送信
9. 全メンバーのシャットダウンを確認後、`TeamDelete()` でチームリソースを削除する

10. **コミットする**：
    ```bash
    git add books/{slug}/manuscript.md
    git commit -m "[{slug}] build: 原稿結合完了"
    ```
